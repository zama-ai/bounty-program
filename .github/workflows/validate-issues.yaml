name: validate-issues

on:
  issues:
    types: [opened, edited, reopened]

permissions:
  issues: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Validate issues templates
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = issue.number;

            const title = (issue.title || "").trim();
            const body = (issue.body || "").trim();

            const INVALID_LABEL = "invalid";
            const LABEL_TPL_GRAL_ISSUE = "tpl-gral-issue";
            const LABEL_TPL_GRANT_APP = "tpl-grant-app";

            const labelNames = (issue.labels || []).map(l => l.name).filter(Boolean);
            const hasLabelGralIssue = labelNames.includes(LABEL_TPL_GRAL_ISSUE);
            const hasLabelGrantApp = labelNames.includes(LABEL_TPL_GRANT_APP);
            const alreadyInvalid = labelNames.includes(INVALID_LABEL);

            console.log("---- DEBUG START ----");
            console.log("Repo:", `${owner}/${repo}`);
            console.log("Issue number:", issue_number);
            console.log("State:", issue.state);
            console.log("Title:", title);
            console.log("Body length:", body.length);
            console.log("Labels:", labelNames.join(", ") || "(none)");
            console.log("hasLabelGralIssue:", hasLabelGralIssue);
            console.log("hasLabelGrantApp:", hasLabelGrantApp);
            console.log("alreadyInvalid:", alreadyInvalid);
            console.log("Actor:", context.payload.sender?.login || "(unknown)");
            console.log("---- DEBUG END ----");

            if (issue.state !== "open") {
              console.log("Issue not open -> skipping.");
              return;
            }
            if (alreadyInvalid) {
              console.log("Already invalid -> skipping.");
              return;
            }

            async function addInvalidLabel() {
              try {
                await github.rest.issues.addLabels({
                  owner, repo, issue_number,
                  labels: [INVALID_LABEL]
                });
                console.log(`Applied label '${INVALID_LABEL}'.`);
              } catch (e) {
                console.log(`Failed to apply label '${INVALID_LABEL}': ${e.message}`);
              }
            }

            async function commentAndClose(reasons) {
              const msg =
                "This issue was closed automatically because it does not follow the required title format.\n\n" +
                "Please edit the title and re-open a new issue using the correct template.";

              await github.rest.issues.createComment({
                owner, repo, issue_number,
                body: msg
              });
              console.log("Comment posted.");

              await github.rest.issues.update({
                owner, repo, issue_number,
                state: "closed"
              });
              console.log("Issue closed.");
            }

            // Must match exactly one template label
            const reasons = [];
            if (hasLabelGralIssue && hasLabelGrantApp) {
              reasons.push(`Issue has both '${LABEL_TPL_GRAL_ISSUE}' and '${LABEL_TPL_GRANT_APP}' labels.`);
            }
            if (!hasLabelGralIssue && !hasLabelGrantApp) {
              reasons.push(`Issue is missing template label ('${LABEL_TPL_GRAL_ISSUE}' or '${LABEL_TPL_GRANT_APP}').`);
            }

            // Title validation per template
            if (hasLabelGralIssue && !hasLabelGrantApp) {
              const isIssuePrefix = /^\[ISSUE\]/i.test(title);
              if (!isIssuePrefix) reasons.push("General issues must start with `[ISSUE]`.");

              // Disallow empty/placeholder titles
              if (/^\[ISSUE\]\s*$/i.test(title)) {
                reasons.push("Title cannot be only `[ISSUE]`.");
              }
              if (/^\[ISSUE\]\s*<enter issue title>\s*$/i.test(title)) {
                reasons.push("Replace the placeholder `<enter issue title>` with a real title.");
              }

              // Also require some real text after the prefix
              if (!/^\[ISSUE\]\s+\S+/i.test(title)) {
                reasons.push("Title must include a real value after `[ISSUE]`.");
              }
            }

            if (hasLabelGrantApp && !hasLabelGralIssue) {
              const isGrantPrefix = /^\[GRANT\]/i.test(title);
              if (!isGrantPrefix) reasons.push("Grant applications must start with `[GRANT]`.");

              if (/^\[GRANT\]\s*$/i.test(title)) {
                reasons.push("Title cannot be only `[GRANT]`.");
              }
              if (/^\[GRANT\]\s*<enter project name>\s*$/i.test(title)) {
                reasons.push("Replace the placeholder `<enter project name>` with a real project name.");
              }

              if (!/^\[GRANT\]\s+\S+/i.test(title)) {
                reasons.push("Title must include a real value after `[GRANT]`.");
              }
            }

            if (reasons.length > 0) {
              console.log("Invalid issue detected. Reasons:");
              for (const r of reasons) console.log(" -", r);

              await addInvalidLabel();
              await commentAndClose(reasons);
            } else {
              console.log("Issue title is valid. No action taken.");
            }
